server {
    listen 80;
    server_name _;

    # Optional redirect to HTTPS if youâ€™re using TLS later
    # return 301 https://$host$request_uri;

    # =============================
    # IGV Web App (protected)
    # =============================
    location /igv {
        # Ask the auth service if this request is allowed
        auth_request /auth;

        # If auth fails, show 401/403 pages
        error_page 401 = @error401;
        error_page 403 = @error403;

        # Forward request to IGV only if auth_request returned 200
        proxy_pass         http://igv:8080;
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }

    # =============================
    # Internal endpoint for JWT verification
    # =============================
    location = /auth {
        internal;  # prevent direct access from outside
        proxy_pass http://auth:8000/verify$is_args$args;  # FastAPI or other service endpoint
        proxy_pass_request_body off;         # no need to send request body
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header Authorization $http_authorization;
    }

    # =============================
    # Error responses for auth failure
    # =============================
    location @error401 {
        add_header Content-Type text/plain;
        return 401 "Unauthorized: Invalid or missing token";
    }

    location @error403 {
        add_header Content-Type text/plain;
        return 403 "Forbidden: Access denied";
    }

    # =============================
    # Optionally serve static IGV frontend
    # =============================
    # location / {
    #     root /usr/share/nginx/html;
    #     index index.html;
    # }
}
